---

layout: post
title:  "Golang开发支持平滑升级（优雅重启）的HTTP服务"
date:   2016-01-28 11:30:00
tags: [golang]

---

前段时间用Golang在做一个HTTP的接口，因编译型语言的特性，修改了代码需要重新编译可执行文件，关闭正在运行的老程序，并启动新程序。对于访问量较大的面向用户的产品，关闭、重启的过程中势必会出现无法访问的情况，从而影响用户体验。



使用Golang的系统包开发HTTP服务，是无法支持平滑升级（优雅重启）的，本文将探讨如何解决该问题。


### 一、平滑升级（优雅重启）的一般思路


一般情况下，要实现平滑升级，需要以下几个步骤：


1. 用新的可执行文件替换老的可执行文件（如只需优雅重启，可以跳过这一步）

1. 通过pid给正在运行的老进程发送 特定的信号（kill -SIGUSR2 $pid）

1. 正在运行的老进程，接收到指定的信号后，以子进程的方式启动新的可执行文件并开始处理新请求

1. 老进程不再接受新的请求，等待未完成的服务处理完毕，然后正常结束

1. 新进程在父进程退出后，会被init进程领养，并继续提供服务


