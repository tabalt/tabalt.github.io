---

layout: post
title:  "第5章：标准I/O库"
date:   2016-11-22 12:30:00
categories: 博文
tags: []

---

包括Unix在内的很多操作系统都实现了标准I/O库，标准I/O库处理缓冲区分配、以优化的块长度执行I/O等很多细节，以便于用户使用，但同时也需要深入的了解I/O库函数的操作，避免带来问题。

### 流和FILE对象

标准I/O库的操作是围绕流（stream）进行的，使用标准I/O库打开或创建一个文件即使一个流和一个文件相关联。

ASCII字符集使用一个字节表示一个字符，国际字符集使用多个字节表示一个字符。标准I/O文件流可用于单字节或多字节（宽）字符集。流的定向决定了读写的字符是单字节还是多字节。新创建的流没有定向，先使用单字节I/O函数操作未定向的流，则将流的定向设置为字节定向，相反则设置为宽定向。freopen函数可以清除一个流的定向，fwide函数可以设置未定向流的定向。

标准I/O函数fopen返回一个指向FILE对象的指针（称为文件指针），为了引用流需要将该指针作为参数传递给每个标准的I/O函数。FILE结构体包含了标准I/O库管理流的所有信息：

* 用于实际I/O的文件描述符
* 指向用于该流缓冲区的指针
* 缓冲区的长度
* 当前在缓冲区的字符数
* 出错标志等


### 标准输入、标准输出和标准错误

一个进程预定义了3个可以自动被进程使用的流：标准输入、标准输出和标准错误，分别用文件指针stdin、stdout、stderr加以引用。


### 缓冲

标准I/O库对每个I/O流自动进行缓冲管理，目的是尽可能减少使用read和write系统调用的次数。缓冲类型有如下三种：

* 全缓冲

    填满标准I/O缓冲区后才进行实际I/O操作，驻留磁盘上的文件通常是全缓冲。缓冲区可由标准I/O函数自动冲洗（将缓冲区的内容写到磁盘上），也可以调用fflush函数冲洗。

* 行缓冲

    输入和输出中遇到换行符后填满缓冲区时，标准I/O执行I/O操作。当流涉及到终端（标准输入和标准输出）时，通常使用行缓冲。
    
    通过标准I/O库从内核系统调用（不带缓冲的流或者暂无缓冲的行缓冲流）而得到输入数据，会冲洗所有行缓冲输出流。

* 不带缓冲

    标准I/O库不对字符进行缓冲存储。标准错误流stderr通常是不带缓冲的，以使错误尽快显示。


setbuf系列函数可以在流打开后执行其他操作钱调用而更改缓冲类型。缓冲的长度通常应由操作系统选择（BUFSIZ常量或stat结构的st_blksize字段），setvbuf函数时也可以手动指定。


### 打开流

fopen系列函数打开一个标准的I/O流：

* fopen函数打开指定文件路径的流
* freopen在一个指定的流上打开指定的文件，若流已打开则先关闭，若流已定向则清除定向，一般用于标准输入、标准输出和标准错误流
* fdopen从一个已有的文件描述符创建I/O流，常用于不能由fopen打开的创建管道和网络通信通道函数返回的描述符

打开流时的type参数hiding对流的读写方式，主要有15种值：

* r或rb，为读打开
* w或wb，把文件截断至0长，或为写创建
* a或ab，追加，为在文件尾写而打开或或为写创建
* r+或r+b或rb+，为读和写而打开
* w+或w+b或wb+，把文件截断至0长，或为读和写打开
* a+或a+b或ab+，为在文件为读写而打开或创建

追加写类型打开一个文件后，每次写都将写到文件的当前尾端处，即使多个进程追加写方式打开同一个文件也能正确写入。

以读和写类型打开文件有下列限制：

* 如果中间没有fflush、fseek、fsetpos、或rewind，则在输出的后面不能直接跟随输入
* 如果中间没有fseek、fsetpos、rewind或者输入操作没有到达文件尾端，则输入操作之后不能直接跟随输出

使用fclose可以关闭一个打开的流，文件被关闭前，会冲洗缓冲中的数据，缓冲中的任何输入数据被丢弃，标准io库自动分配的缓冲区被释放。


### 读和写流




更多有关[《Unix环境高级编程 3》的读书笔记](http://tabalt.net/blog/advanced-programming-in-the-unix-environment-3-reading-notes/)，请关注 ：   
[http://tabalt.net/blog/advanced-programming-in-the-unix-environment-3-reading-notes/](http://tabalt.net/blog/advanced-programming-in-the-unix-environment-3-reading-notes/)


